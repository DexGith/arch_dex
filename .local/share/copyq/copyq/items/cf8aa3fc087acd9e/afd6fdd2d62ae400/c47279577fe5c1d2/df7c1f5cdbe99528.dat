#!/bin/bash
#
# This script syncs personal configuration files from this Arch Linux system
# into this git repository. It correctly separates system packages from user configs.
#
# IMPORTANT: This script should be run as your NORMAL user, not with sudo.
#            It will ask for your password only when needed for system files.
#
# ONE-TIME FIX for existing repo permissions:
# If you previously ran this script with sudo, fix the file ownership by running:
# sudo chown -R $(whoami):$(whoami) /path/to/your/repo
# e.g.: sudo chown -R dex:dex ~/git/arch_dex

set -e

# --- Configuration ---
# Get the directory where this script is located.
REPO_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" &> /dev/null && pwd)
HOME_DIR=~

# --- System Level Configs ---
# These files require sudo to read.
SYSTEM_FILES_TO_SYNC=(
    "/etc/fstab"
    "/etc/pacman.conf"
    "/etc/default/grub"
    "/etc/sudoers"
    "/etc/hostname"
    "/etc/locale.gen"
    "/etc/vconsole.conf"
    "/etc/keyd/default.conf"
    "/usr/bin/keyd-application-mapper"
    "/usr/bin/keyd-application-mapper.bak"
)
SYSTEM_DIRS_TO_SYNC=(
    "/etc/sudoers.d"
    "/usr/local/bin"
)

# --- Home Directory Configs (run as your user) ---
# Add single dotfiles from your home directory (~) here.
HOME_FILES_TO_SYNC=(
    ".zshrc"
    ".zshenv"
    ".gitconfig"
    ".tmux.conf"
    ".bashrc"
    ".vimrc"
    ".bash_logout"
    ".nanorc"
    ".profile"
    ".xbindkeysrc"
    ".xmodmaprc"
    ".Xresources"
    ".Xdefaults"
    ".Xauthority"
)

# Add directories from your HOME folder here.
HOME_DIRS_TO_SYNC=(
    "scripts"
    "Home/K/Keepassxc"
    ".config/alacritty"
    ".config/mimeapps.list"
    ".config/picom" # Sync the whole dir, not just the conf file
    ".config/espanso"
    ".config/copyq"
    ".config/dolphinrc"
    ".config/autostart"
    ".config/autokey"
    ".config/lxqt"
    ".config/lxpanel"
    ".config/Thunar"
    ".config/vlc"
    ".config/mpv"
    ".config/kitty"
    ".config/keepassxc"
    ".config/Deskflow"
    ".config/nvim"
    ".config/input-remapper-2"
    ".config/openbox"
    ".config/openrazer"
    ".config/rofi"
    ".config/skippy-xd"
    ".config/sublime-text"
    ".config/sxhkd"
    ".config/zsh" # This is now the ONLY zsh entry needed. It will sync everything inside.
    ".config/tmux-sessionizer"
    ".config/waybar"
    ".local/share/applications"
    ".local/share/tmux"
    ".local/share/copyq"
    ".local/share/fonts"
    ".local/state/nvim"
    ".local/state/syncthing"
    ".local/scripts"
    ".local/bin"
)
# --- End of Configuration ---


echo "üîµ Starting personalized sync..."
echo "   Repo Destination: $REPO_DIR"
echo ""

# --- 1. Generate Package Lists ---
echo "üì¶ Generating package lists..."
pacman -Qqe > "$REPO_DIR/package_list_explicit.txt"
pacman -Qqm > "$REPO_DIR/package_list_foreign.txt"
echo "   - Done."
echo ""

# --- 2. Sync Home Directory Configs ---
echo "üè† Syncing files & directories from your Home folder ($HOME_DIR)..."

# Sync single dotfiles from home
for file in "${HOME_FILES_TO_SYNC[@]}"; do
    source_path="$HOME_DIR/$file"
    dest_path="$REPO_DIR/$file"

    if [ -f "$source_path" ]; then
        echo "   - Syncing file: ~/$file"
        mkdir -p "$(dirname "$dest_path")"
        rsync -av "$source_path" "$dest_path"
    else
        echo "   - WARNING: File ~/$file not found. Skipping."
    fi
done

# Sync whole directories from home
# **FIXED LOGIC**: Using -R to preserve directory structure relative to home.
for dir in "${HOME_DIRS_TO_SYNC[@]}"; do
    source_path="$HOME_DIR/$dir"
    
    if [ -e "$source_path" ]; then # Use -e to check for file or dir
        echo "   - Syncing path: ~/$dir"
        # The -R flag makes rsync create the parent directories in the destination
        # e.g., it copies '~/.config/zsh' to './.config/zsh' inside the repo
        rsync -avR --delete "$source_path" "$REPO_DIR/"
    else
        echo "   - WARNING: Path ~/$dir not found. Skipping."
    fi
done
echo ""

# --- 3. Sync Specific System Files & Dirs ---
# **PERMISSIONS FIX**: Using `sudo` ONLY for the rsync commands here.
echo "‚öôÔ∏è  Syncing specific system-level configs (will ask for password if needed)..."
for file_path in "${SYSTEM_FILES_TO_SYNC[@]}"; do
    if [ -e "$file_path" ]; then
        echo "   - Syncing file: $file_path"
        sudo rsync -avR "$file_path" "$REPO_DIR/"
    else
        echo "   - WARNING: File $file_path not found. Skipping."
    fi
done

for dir_path in "${SYSTEM_DIRS_TO_SYNC[@]}"; do
    if [ -d "$dir_path" ]; then
        echo "   - Syncing dir:  $dir_path/"
        sudo rsync -avR --delete "$dir_path/" "$REPO_DIR/"
    else
        echo "   - WARNING: Directory $dir_path not found. Skipping."
    fi
done

echo ""
echo "‚úÖ Sync complete! Your personal configs are backed up."
echo "Run 'git status' to see what has changed."